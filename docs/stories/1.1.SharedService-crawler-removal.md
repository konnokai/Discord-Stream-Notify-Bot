# Story 1.1: SharedService 爬蟲邏輯移除

## Status
Draft

## Story
**As a** 系統架構師,
**I want** 移除 SharedService 目錄中所有平台的爬蟲相關程式碼,
**so that** Discord Bot 可以專注於 Discord 互動功能，為後續 Crawler 服務分離奠定基礎

## Acceptance Criteria

1. [ ] 移除 `SharedService/Youtube/YoutubeStreamService.cs` 中的 Timer 和爬蟲邏輯
   - 保留 YouTube API 查詢方法（僅供 Discord 指令讀取使用）
   - 移除所有定時執行的背景任務
   - 移除資料寫入邏輯（PubSubHubbub 訂閱、資料庫更新等轉移至 Crawler）
2. [ ] 移除 `SharedService/Twitch/TwitchService.cs` 中的定時監控程式碼
   - 保留 Twitch API 查詢邏輯（僅供 Discord 指令使用）
   - 移除 EventSub 訂閱管理（轉移至 Crawler）
   - 移除所有資料寫入和更新邏輯
3. [ ] 移除 `SharedService/Twitter/TwitterSpacesService.cs` 中的輪詢機制
   - 保留 Twitter API 基礎查詢方法（僅供 Discord 指令使用）
   - 移除定時檢查 Spaces 狀態的邏輯
   - 移除資料寫入和狀態更新邏輯
4. [ ] 移除 `SharedService/Twitcasting/TwitcastingService.cs` 中的爬蟲功能
   - 保留 API 查詢封裝（僅供 Discord 指令使用）
   - 移除背景監控任務
   - 移除資料寫入和更新邏輯
5. [ ] 保留 `EmojiService.cs` 和其他輔助服務
6. [ ] 更新依賴注入配置，移除已刪除服務的註冊
7. [ ] 確保移除程式碼不影響現有 Discord 指令功能

## Tasks / Subtasks

- [ ] Task 1: 分析 YouTube 服務的 Timer 依賴 (AC: 1)
  - [ ] 分析 `YoutubeStreamService.cs` 建構子中的 Timer 初始化
  - [ ] 識別需要移除的 Timer 物件：`checkScheduleTime`, `saveDateBase`, `subscribePubSub`, `channelTitleCheckTimer`
  - [ ] 記錄保留的 API 方法和資料存取邏輯
  - [ ] 分析 `HoloScheduleAsync`, `NijisanjiScheduleAsync`, `OtherScheduleAsync`, `CheckScheduleTime` 方法依賴關係

- [ ] Task 2: 移除 YouTube 服務爬蟲邏輯 (AC: 1)
  - [ ] 移除建構子中的所有 Timer 初始化：
    - `checkScheduleTime = new Timer(async (objState) => await CheckScheduleTime(), null, TimeSpan.FromMinutes(15), TimeSpan.FromMinutes(15))`
    - `saveDateBase = new Timer((objState) => SaveDateBase(), null, TimeSpan.FromMinutes(1), TimeSpan.FromMinutes(3))`
    - `subscribePubSub = new Timer(...)`
    - `channelTitleCheckTimer = new Timer(...)`
  - [ ] 移除排程相關方法：`HoloScheduleAsync()`, `NijisanjiScheduleAsync()`, `OtherScheduleAsync()`, `CheckScheduleTime()`
  - [ ] 保留查詢 API 方法：`GetVideosAsync()` 等 YouTube Data API 封裝方法（僅保留讀取功能）
  - [ ] 移除資料寫入方法：`AddOtherDataAsync()`, `SaveDateBase()`, `PostSubscribeRequestAsync()` (這些將轉移至 Crawler 服務)
  - [ ] 移除 `Schedule.cs` 檔案中的所有排程邏輯

- [ ] Task 3: 移除其他平台服務的爬蟲邏輯 (AC: 2, 3, 4)
  - [ ] 識別 Twitch 服務中的 Timer 和背景任務
  - [ ] 識別 Twitter 服務中的輪詢機制
  - [ ] 識別 TwitCasting 服務中的監控邏輯
  - [ ] 移除相關 Timer 和背景執行緒
  - [ ] 保留 API 調用和資料處理方法

- [ ] Task 4: 更新依賴注入和服務註冊 (AC: 6)
  - [ ] 檢查 `Bot.cs` 中的服務註冊
  - [ ] 移除或調整已簡化服務的註冊方式
  - [ ] 確保保留的方法可以透過依賴注入正常調用
  - [ ] 更新服務生命週期管理（從 Singleton 改為 Scoped 如有需要）

- [ ] Task 5: 分析和處理 Discord 指令中的 Spider 相關功能 (AC: 7)
  - [ ] 分析 `Interaction/Youtube/YoutubeChannelSpider.cs` 的 add/remove 功能：
    - `AddChannelSpider()` - 新增 YouTube 頻道爬蟲到資料庫
    - `RemoveChannelSpider()` - 移除 YouTube 頻道爬蟲
    - 按鈕事件處理（trusted/untrusted, record/unrecord）
  - [ ] 分析 `Interaction/Twitch/TwitchSpider.cs` 的 add/remove 功能：
    - `AddChannelSpider()` - 新增 Twitch 頻道爬蟲
    - `RemoveChannelSpider()` - 移除 Twitch 頻道爬蟲
  - [ ] 分析 `Interaction/Twitter/TwitterSpacesSpider.cs` 的 add/remove 功能：
    - `AddSpider()` - 新增 Twitter Spaces 爬蟲
    - `RemoveSpider()` - 移除 Twitter Spaces 爬蟲
  - [ ] 分析 `Interaction/Youtube/Youtube.cs` 的通知設定功能：
    - `AddChannel()` - 新增 YouTube 直播通知
    - `RemoveChannel()` - 移除 YouTube 直播通知
- [ ] 確認需要透過 Redis PubSub 轉移到 Crawler 的功能：
    - 所有 Spider add/remove 操作（爬蟲實體的註冊/移除）
  - [ ] 確認可以保留在 Discord Bot 直接操作資料庫的功能：
    - 所有通知設定功能：`add`, `remove` (通知頻道設定)
    - `set-message` - 通知訊息設定
    - `set-video-notice-channel` - 影片通知頻道設定
    - `toggle-create-event` - Discord 活動建立設定

- [ ] Task 6: 驗證 Discord 指令功能完整性 (AC: 7)
  - [ ] 測試所有 YouTube 相關指令是否正常運作
  - [ ] 測試其他平台指令功能
  - [ ] 確認 EmojiService 等輔助服務正常運作
  - [ ] 驗證資料庫存取功能未受影響

- [ ] Task 7: 程式碼清理和重構 (AC: 1-5)
  - [ ] 移除未使用的 using 陳述式
  - [ ] 清理未引用的變數和方法
  - [ ] 更新類別註解和文件註解
  - [ ] 確保程式碼符合現有編碼標準

## Dev Notes

### 系統現狀分析 (基於棕地架構)
**[Source: docs/brownfield-architecture.md]**

當前 Discord Stream Notify Bot 採用單體架構，所有平台爬蟲邏輯和 Discord Bot 功能運行在同一進程中。重構目標是將其轉換為 Coordinator-Shard 分散式架構，第一步是移除 Discord Bot 中的爬蟲邏輯。

### 關鍵技術特徵

**技術棧**:
- .NET 8.0
- Discord.Net 3.17.2  
- Entity Framework Core 9.0.3
- Redis PubSub 用於服務間通訊
- MySQL + Pomelo EF Core 驅動

**現有爬蟲架構問題**:
- 大量 Timer 物件用於定時任務：爬蟲輪詢、提醒、狀態檢查
- 無統一的工作排程系統，難以監控和管理
- Timer 錯誤處理不一致，可能導致靜默失敗

### Interaction 指令中的 Spider 資料寫入分析

**影響範圍識別**：

**YouTube 平台**：
- `Interaction/Youtube/YoutubeChannelSpider.cs`:
  - `AddChannelSpider()` - 直接寫入 `YoutubeChannelSpider` 資料表 (**轉移至 Crawler**)
  - `RemoveChannelSpider()` - 移除爬蟲記錄 (**轉移至 Crawler**)
  - Button 事件處理 - 更新 `IsTrustedChannel`, `RecordYoutubeChannel` 資料 (**轉移至 Crawler**)
- `Interaction/Youtube/Youtube.cs`:
  - `AddChannel()` - 寫入 `NoticeYoutubeStreamChannel` 資料表 (**保留在 Discord Bot**)
  - `RemoveChannel()` - 移除通知設定 (**保留在 Discord Bot**)
  - `SetMessage()` - 設定通知訊息 (**保留在 Discord Bot**)

**Twitch 平台**：
- `Interaction/Twitch/TwitchSpider.cs`:
  - `AddChannelSpider()` - 寫入 `TwitchSpider` 資料表 (**轉移至 Crawler**)
  - `RemoveChannelSpider()` - 移除爬蟲記錄 (**轉移至 Crawler**)
- `Interaction/Twitch/Twitch.cs`:
  - `AddChannel()` - 寫入 `NoticeTwitchStreamChannel` 資料表 (**保留在 Discord Bot**)
  - `RemoveChannel()` - 移除通知設定 (**保留在 Discord Bot**)
  - `SetMessage()` - 設定通知訊息 (**保留在 Discord Bot**)

**Twitter 平台**：
- `Interaction/Twitter/TwitterSpacesSpider.cs`:
  - `AddSpider()` - 寫入 `TwitterSpaceSpider` 資料表 (**轉移至 Crawler**)
  - `RemoveSpider()` - 移除爬蟲記錄 (**轉移至 Crawler**)
- `Interaction/Twitter/TwitterSpaces.cs`:
  - `AddSpaceNotice()` - 寫入通知設定 (**保留在 Discord Bot**)
  - `RemoveSpaceNotice()` - 移除通知設定 (**保留在 Discord Bot**)
  - `SetMessage()` - 設定通知訊息 (**保留在 Discord Bot**)

**TwitCasting 平台**：
- `Interaction/Twitcasting/TwitcastingSpider.cs`:
  - 爬蟲註冊相關的 add/remove 功能 (**轉移至 Crawler**)
- `Interaction/Twitcasting/Twitcasting.cs`:
  - 通知設定功能 (**保留在 Discord Bot**)

**轉移策略**：
只有 Spider 爬蟲註冊相關的資料寫入操作（Spider 新增/移除）需要透過 Redis PubSub 事件發送給 Crawler 服務處理。通知設定功能（通知頻道新增/移除、訊息設定、頻道設定）可以保留在 Discord Bot 直接操作資料庫。

### Discord 指令轉移影響分析

**指令行為變化**：
1. **查詢類指令** (保留在 Discord Bot):
   - `list` - 顯示現有的追蹤清單
   - `list-message` - 顯示通知訊息設定
   - `now-streaming` - 顯示當前直播狀態

2. **設定類指令** (保留在 Discord Bot，直接操作資料庫):
   - `set-message` - 設定通知訊息（僅修改訊息內容，不涉及爬蟲註冊）
   - `set-video-notice-channel` - 設定影片通知頻道
   - `toggle-create-event` - 切換建立 Discord 活動功能

3. **爬蟲註冊類指令** (透過 PubSub 委託給 Crawler):
   - 所有 Spider 相關的 add/remove 操作（爬蟲實體的註冊和移除）

4. **通知註冊類指令** (保留在 Discord Bot，直接操作資料庫):
   - `add` - 新增頻道通知設定（不涉及爬蟲註冊）
   - `remove` - 移除頻道通知設定（不涉及爬蟲移除）

**實作方式**：
- **爬蟲註冊操作**: Discord 指令接收使用者請求 → 驗證參數和權限 → 發送事件到 Redis PubSub 頻道 → Crawler 服務執行爬蟲註冊/移除和資料庫操作 → 回傳結果給 Discord Bot
- **通知和設定操作**: Discord 指令直接操作資料庫（如通知設定、訊息設定、頻道設定等）

### 專案結構影響範圍

**需要重構的核心模組**:
```
DiscordStreamNotifyBot/SharedService/
├── Youtube/
│   ├── YoutubeStreamService.cs      # 主要爬蟲邏輯，包含多個 Timer
│   ├── Schedule.cs                  # 排程相關方法，需要完全移除
│   ├── ReminderAction.cs           # 提醒功能，需要保留部分 API 方法
│   └── [其他檔案]                   # API 調用和工具方法，大部分保留
├── Twitch/                         # 類似模式，移除定時監控
├── Twitter/                        # 移除輪詢機制
├── Twitcasting/                    # 移除背景監控
└── EmojiService.cs                 # 完全保留，輔助服務

DiscordStreamNotifyBot/Interaction/
├── Youtube/
│   ├── YoutubeChannelSpider.cs     # Spider add/remove 需改為 PubSub 方式
│   └── Youtube.cs                  # 通知 add/remove 需改為 PubSub 方式
├── Twitch/
│   ├── TwitchSpider.cs             # 同樣需要 PubSub 轉移
│   └── Twitch.cs                   # 通知功能需要 PubSub 轉移
├── Twitter/
│   ├── TwitterSpacesSpider.cs      # Twitter Spaces 爬蟲管理
│   └── TwitterSpaces.cs            # 通知設定管理
└── [其他平台類似結構]
```

### YouTube 服務詳細分析

**Timer 物件識別** (來源: YoutubeStreamService.cs 建構子):
```csharp
// 需要移除的 Timer 物件
checkScheduleTime = new Timer(async (objState) => await CheckScheduleTime(), null, TimeSpan.FromMinutes(15), TimeSpan.FromMinutes(15));
saveDateBase = new Timer((objState) => SaveDateBase(), null, TimeSpan.FromMinutes(1), TimeSpan.FromMinutes(3));
subscribePubSub = new Timer(async (objState) => await SubscribePubSubAsync(), null, TimeSpan.FromMinutes(1), TimeSpan.FromMinutes(30));
channelTitleCheckTimer = new Timer(async _ => await CheckAndUpdateYoutubeChannelTitlesAsync(), null, dueTime, TimeSpan.FromDays(1));
```

**需要移除的排程方法** (來源: Schedule.cs):
- `HoloScheduleAsync()` - Hololive 直播排程檢查
- `NijisanjiScheduleAsync()` - Nijisanji 直播排程檢查  
- `OtherScheduleAsync()` - 其他頻道突襲開台檢測
- `CheckScheduleTime()` - 定時檢查排程時間變更

**需要保留的 API 方法** (供 Discord 指令使用):
- `GetVideosAsync()` - YouTube Data API v3 調用（僅查詢功能）
- 基礎資料格式化方法（用於指令回應顯示）

**需要移除的方法** (轉移至 Crawler 服務):
- `PostSubscribeRequestAsync()` - PubSubHubbub 訂閱請求
- `AddOtherDataAsync()` - 資料新增邏輯  
- `SaveDateBase()` - 資料庫更新邏輯

### 服務依賴關係

**依賴注入影響**:
- YoutubeStreamService 目前註冊為 Singleton
- 移除爬蟲邏輯後可能需要調整為 Scoped
- 其他服務 (Twitch, Twitter, TwitCasting) 類似調整

**資料庫存取保持不變**:
- 繼續使用 MainDbService 進行資料庫操作
- Entity Framework 配置無需修改
- 現有 Table 結構保持不變

**Discord 指令相依性**:
- Command/ 和 Interaction/ 中的指令僅需要查詢功能（如頻道資訊、直播狀態）
- 確保保留的查詢 API 方法可以正常被指令調用，但移除所有寫入操作
- 資料寫入操作（follow/unfollow）將透過 Redis PubSub 發送給 Crawler 處理（Story 1.2）
- EmojiService 被多個指令使用，必須完全保留

### 技術風險

**主要風險**:
- 意外移除必要的共用邏輯，影響 Discord 指令功能
- Timer dispose 處理不當，可能導致記憶體洩漏
- 服務生命週期調整可能影響既有功能
- **Spider 指令資料寫入轉移** - 所有 add/remove 操作從直接資料庫存取改為 PubSub 事件可能影響回應時間

**緩解措施**:
- 仔細識別並保留 API 查詢方法，供 Discord 指令使用
- 在 Dispose 方法中正確清理所有 Timer 資源
- 逐步測試每個平台的指令功能確保無回歸
- **分階段實作 Spider 指令轉移** - 先確保 PubSub 通訊正常運作再移除直接資料庫存取

### 專案結構備註

根據現有專案結構，所有 SharedService 邏輯位於單一 DiscordStreamNotifyBot.csproj 專案中。重構後，這些邏輯將：
1. **移除的邏輯**: 定時爬蟲、排程檢查、PubSubHubbub 訂閱、資料寫入 → 轉移至獨立 Crawler 服務
2. **保留的邏輯**: API 查詢、資料格式化（僅讀取功能） → 繼續在 Discord Bot 中可用
3. **輔助服務**: EmojiService 等 → 完全不變
4. **指令行為變化**: follow/unfollow 等寫入操作將透過 Redis PubSub 委託給 Crawler 處理

### Testing

根據專案現狀，沒有發現專門的測試框架配置。建議進行手動測試：
- 測試所有平台的 Discord 指令 (follow, unfollow, list 等)
- 確認 EmojiService 在各種 Discord 回應中正常運作
- 驗證資料庫讀寫功能未受影響
- 檢查記憶體使用情況，確認 Timer 正確釋放

測試重點：
- 移除爬蟲邏輯後，Discord 指令仍能正常回應使用者
- **爬蟲註冊功能**：`youtube-spider add/remove`, `twitch-spider add/remove`, `twitter-space-spider add/remove`
- **保留的直接資料庫操作**：
  - 通知設定：`youtube add/remove`, `twitch add/remove`, `twitter-space add/remove`
  - 訊息設定：`set-message`, `set-video-notice-channel`, `toggle-create-event` 等
- **查詢功能正常**：`list`, `list-message`, `now-streaming` 等指令
- 僅爬蟲註冊操作透過 PubSub 委託，其他操作直接存取資料庫
- 系統啟動和關閉過程中無異常

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-18 | 1.0 | Story 初始建立 | Scrum Master |

## Dev Agent Record

_此區段由開發代理在實作期間填寫_

### Agent Model Used

_待開發代理填寫_

### Debug Log References

_待開發代理填寫_

### Completion Notes List

_待開發代理填寫_

### File List

_待開發代理填寫_

## QA Results

_此區段由 QA 代理在完成故事實作的 QA 審查後填寫_
