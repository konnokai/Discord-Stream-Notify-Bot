# Story 2.1: Crawler 專案架構建立

## Status
Draft

## Story
**As a** 系統架構師,
**I want** 建立新的 StreamNotifyBot.Crawler 專案和基礎架構,
**so that** 準備承接爬蟲邏輯並支援獨立的爬蟲服務部署

## Acceptance Criteria

1. [ ] 建立 `StreamNotifyBot.Crawler/` 專案目錄結構
   - 建立完整的專案目錄架構
   - 設定 .NET 8.0 專案檔案
   - 建立標準的企業級專案結構
2. [ ] 建立 `Program.cs` 主進入點和依賴注入配置
   - ASP.NET Core Host 配置
   - 服務生命週期管理
   - 配置檔案載入
3. [ ] 建立 `CrawlerService.cs` 主服務類別
   - 實作 `IHostedService` 介面
   - 服務啟動和停止邏輯
   - 各平台監控器管理
4. [ ] 設定 NuGet 套件依賴
   - Entity Framework Core 9.0.3
   - StackExchange.Redis
   - Google.Apis.YouTube.v3
   - 其他平台 API 套件
5. [ ] 配置 Entity Framework、Redis、HTTP Client 服務註冊
   - 資料庫連接字串配置
   - Redis 連接設定
   - HTTP Client Factory 設定
6. [ ] 建立基礎配置模型和管理機制
   - 配置檔案結構定義
   - 環境變數支援
   - 配置驗證機制

## Tasks / Subtasks

- [ ] Task 1: 建立專案基礎架構 (AC: 1)
  - [ ] 建立 `StreamNotifyBot.Crawler/` 專案目錄
  - [ ] 建立 `StreamNotifyBot.Crawler.csproj` 專案檔案
  - [ ] 設定目標框架為 .NET 8.0
  - [ ] 建立標準目錄結構：
    - `PlatformMonitors/` - 各平台監控器
    - `WebhookHandlers/` - API Webhook 處理
    - `MemberVerification/` - 會員驗證邏輯
    - `Configuration/` - 配置管理
    - `Models/` - 資料模型
    - `Services/` - 共用服務

- [ ] Task 2: 設定 NuGet 套件依賴 (AC: 4)
  - [ ] 新增 Entity Framework Core 9.0.3 相關套件：
    - `Microsoft.EntityFrameworkCore`
    - `Pomelo.EntityFrameworkCore.MySql`
    - `Microsoft.EntityFrameworkCore.Tools`
  - [ ] 新增 Redis 相關套件：
    - `StackExchange.Redis`
  - [ ] 新增平台 API 套件：
    - `Google.Apis.YouTube.v3`
    - `TwitchLib.Api`
    - `Newtonsoft.Json`
  - [ ] 新增 ASP.NET Core 相關套件：
    - `Microsoft.Extensions.Hosting`
    - `Microsoft.Extensions.DependencyInjection`
    - `Microsoft.Extensions.Configuration`
    - `Microsoft.Extensions.Configuration.Json`
    - `Microsoft.Extensions.Logging`

- [ ] Task 3: 建立程式主進入點 (AC: 2)
  - [ ] 建立 `Program.cs` 主進入點
  - [ ] 設定 ASP.NET Core Host Builder
  - [ ] 配置依賴注入容器
  - [ ] 設定配置檔案載入機制
  - [ ] 建立應用程式生命週期管理
  - [ ] 設定日誌提供者

- [ ] Task 4: 實作核心服務類別 (AC: 3)
  - [ ] 建立 `CrawlerService.cs` 實作 `IHostedService`
  - [ ] 實作 `StartAsync` 方法初始化平台監控器
  - [ ] 實作 `StopAsync` 方法優雅關閉服務
  - [ ] 建立平台監控器管理邏輯
  - [ ] 實作服務狀態管理和報告

- [ ] Task 5: 建立配置管理系統 (AC: 6)
  - [ ] 建立 `Configuration/CrawlerConfig.cs` 配置模型
  - [ ] 實作配置檔案結構定義：
    - Redis 連接配置
    - 資料庫連接配置
    - 各平台 API 配置
    - 監控間隔設定
  - [ ] 建立 `appsettings.json` 預設配置檔案
  - [ ] 實作環境變數覆蓋機制
  - [ ] 建立配置驗證邏輯

- [ ] Task 6: 設定服務依賴注入 (AC: 5)
  - [ ] 設定 Entity Framework DbContext 註冊
  - [ ] 設定 Redis 連接服務註冊
  - [ ] 設定 HTTP Client Factory 註冊
  - [ ] 建立平台 API 服務註冊
  - [ ] 設定日誌服務註冊
  - [ ] 建立服務生命週期配置

- [ ] Task 7: 建立基礎模型和介面 (AC: 1, 3)
  - [ ] 建立 `Models/PlatformMonitorStatus.cs` 狀態模型
  - [ ] 建立 `Services/IPlatformMonitor.cs` 平台監控介面
  - [ ] 建立 `Services/IStreamTracker.cs` 追蹤管理介面
  - [ ] 建立基礎事件模型和資料結構
  - [ ] 實作服務健康檢查模型

- [ ] Task 8: 建立健康檢查端點 (AC: 3)
  - [ ] 實作 HTTP 健康檢查端點 `/health`
  - [ ] 檢查資料庫連接狀態
  - [ ] 檢查 Redis 連接狀態
  - [ ] 檢查各平台監控器狀態
  - [ ] 提供詳細的健康狀態報告

## Dev Notes

### 專案架構參考
**[Source: docs/brownfield-architecture.md#核心設計原則（獨立爬蟲服務模式）]**

此 Story 是建立獨立 Crawler 服務的基礎步驟。Crawler 服務將從原本的 Discord Bot 中分離出來，專責處理所有平台的直播監控、API 管理和會員驗證。

### 目錄結構設計
**[Source: docs/brownfield-architecture.md#需要建立的新元件]**

```
StreamNotifyBot.Crawler/
├── StreamNotifyBot.Crawler.csproj
├── Program.cs                    # 主程式入口
├── CrawlerService.cs             # 核心爬蟲邏輯
├── appsettings.json              # 預設配置
├── PlatformMonitors/             # 各平台監控實作
├── WebhookHandlers/              # API Webhook 處理
├── MemberVerification/           # 會員驗證邏輯
├── Configuration/                # 配置管理
├── Models/                       # 資料模型
└── Services/                     # 共用服務
```

### 技術棧要求
**[Source: docs/brownfield-architecture.md#實際技術堆疊]**

- **執行環境**: .NET 8.0
- **框架**: ASP.NET Core Host (無 Web API)
- **資料庫**: MySQL + Entity Framework Core 9.0.3
- **快取**: Redis (StackExchange.Redis)
- **YouTube API**: Google.Apis.YouTube.v3 1.69.0.3707

### 服務架構設計
**[Source: docs/brownfield-architecture.md#Crawler 服務（獨立專案）]**

Crawler 服務採用背景服務模式 (Hosted Service)，不需要 Web API 端點，主要職責包括：
- 專責爬蟲邏輯：執行所有平台的直播狀態檢測
- 狀態變化廣播：透過 Redis PubSub 通知所有 Discord Shard
- 追蹤管理：監聽 follow/unfollow 事件，動態調整爬蟲目標
- 定期維護：清理失效追蹤、API 配額管理、錯誤恢復

### Program.cs 實作範例
**[Source: docs/brownfield-architecture.md#核心功能]**

```csharp
public class Program
{
    public static async Task Main(string[] args)
    {
        var host = Host.CreateDefaultBuilder(args)
            .ConfigureAppConfiguration((context, config) =>
            {
                config.AddJsonFile("appsettings.json", optional: false);
                config.AddJsonFile($"appsettings.{context.HostingEnvironment.EnvironmentName}.json", optional: true);
                config.AddEnvironmentVariables();
            })
            .ConfigureServices((context, services) =>
            {
                // 設定配置
                services.Configure<CrawlerConfig>(context.Configuration);
                
                // 註冊核心服務
                services.AddHostedService<CrawlerService>();
                
                // 註冊資料庫服務
                var connectionString = context.Configuration.GetConnectionString("Database");
                services.AddDbContext<MainDbContext>(options =>
                    options.UseMySql(connectionString, ServerVersion.AutoDetect(connectionString)));
                
                // 註冊 Redis 服務
                var redisConnection = context.Configuration.GetConnectionString("Redis");
                services.AddSingleton<IConnectionMultiplexer>(ConnectionMultiplexer.Connect(redisConnection));
                
                // 註冊 HTTP 客戶端
                services.AddHttpClient();
                
                // 註冊平台服務
                services.AddTransient<IYoutubeMonitor, YoutubeMonitor>();
                services.AddTransient<ITwitchMonitor, TwitchMonitor>();
                services.AddTransient<ITwitterMonitor, TwitterMonitor>();
                services.AddTransient<ITwitCastingMonitor, TwitCastingMonitor>();
            })
            .ConfigureLogging(logging =>
            {
                logging.ClearProviders();
                logging.AddConsole();
                logging.SetMinimumLevel(LogLevel.Information);
            })
            .Build();

        await host.RunAsync();
    }
}
```

### CrawlerService 架構
**[Source: docs/brownfield-architecture.md#核心功能]**

```csharp
public class CrawlerService : BackgroundService
{
    private readonly IServiceProvider _serviceProvider;
    private readonly ILogger<CrawlerService> _logger;
    private readonly IConfiguration _configuration;

    public async Task StartAsync(CancellationToken cancellationToken)
    {
        _logger.LogInformation("Starting Crawler Service...");

        // 初始化資料庫連接
        await InitializeDatabaseAsync();

        // 初始化 Redis 連接
        await InitializeRedisAsync();

        // 啟動所有平台監控器
        await StartPlatformMonitorsAsync();

        // 監聽 Discord Shard 的追蹤請求
        await StartEventListenersAsync();

        // 啟動定期維護任務
        _ = Task.Run(PeriodicMaintenanceAsync, cancellationToken);

        _logger.LogInformation("Crawler Service started successfully");
    }

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            // 主要服務迴圈
            await Task.Delay(1000, stoppingToken);
        }
    }

    public async Task StopAsync(CancellationToken cancellationToken)
    {
        _logger.LogInformation("Stopping Crawler Service...");
        
        // 優雅關閉所有平台監控器
        await StopPlatformMonitorsAsync();
        
        // 關閉 Redis 連接
        await CloseRedisConnectionAsync();
        
        _logger.LogInformation("Crawler Service stopped");
    }
}
```

### 配置管理模型
**[Source: docs/brownfield-architecture.md#配置管理簡化]**

```csharp
public class CrawlerConfig
{
    public DatabaseConfig Database { get; set; } = new();
    public RedisConfig Redis { get; set; } = new();
    public PlatformConfig Platforms { get; set; } = new();
    public MonitoringConfig Monitoring { get; set; } = new();
}

public class DatabaseConfig
{
    public string ConnectionString { get; set; } = "";
}

public class RedisConfig
{
    public string ConnectionString { get; set; } = "localhost:6379";
}

public class PlatformConfig
{
    public YouTubeConfig YouTube { get; set; } = new();
    public TwitchConfig Twitch { get; set; } = new();
    public TwitterConfig Twitter { get; set; } = new();
    public TwitCastingConfig TwitCasting { get; set; } = new();
}

public class MonitoringConfig
{
    public int CheckIntervalSeconds { get; set; } = 30;
    public int HealthCheckPort { get; set; } = 6111;
    public int MaxRetryAttempts { get; set; } = 3;
}
```

### 健康檢查實作
**[Source: docs/brownfield-architecture.md#統一健康檢查]**

```csharp
public class CrawlerHealthCheck : IHealthCheck
{
    private readonly MainDbContext _dbContext;
    private readonly IConnectionMultiplexer _redis;
    private readonly ILogger<CrawlerHealthCheck> _logger;

    public async Task<HealthCheckResult> CheckHealthAsync(
        HealthCheckContext context, 
        CancellationToken cancellationToken = default)
    {
        var healthData = new Dictionary<string, object>();

        try
        {
            // 檢查資料庫連接
            var dbHealthy = await CheckDatabaseHealthAsync();
            healthData.Add("database", dbHealthy ? "healthy" : "unhealthy");

            // 檢查 Redis 連接
            var redisHealthy = await CheckRedisHealthAsync();
            healthData.Add("redis", redisHealthy ? "healthy" : "unhealthy");

            // 檢查平台監控器狀態
            var platformStatus = await GetPlatformMonitorStatusAsync();
            healthData.Add("platforms", platformStatus);

            var isHealthy = dbHealthy && redisHealthy;
            
            return isHealthy 
                ? HealthCheckResult.Healthy("Crawler service is healthy", healthData)
                : HealthCheckResult.Unhealthy("Crawler service has issues", data: healthData);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Health check failed");
            return HealthCheckResult.Unhealthy("Health check exception", ex, healthData);
        }
    }
}
```

### 平台監控介面設計
**[Source: docs/brownfield-architecture.md#統一的平台監控介面 `IPlatformMonitor`]**

```csharp
public interface IPlatformMonitor
{
    string PlatformName { get; }
    Task StartAsync(CancellationToken cancellationToken);
    Task StopAsync(CancellationToken cancellationToken);
    Task<PlatformMonitorStatus> GetStatusAsync();
    event EventHandler<StreamStatusChangedEventArgs> StreamStatusChanged;
}

public class PlatformMonitorStatus
{
    public string PlatformName { get; set; } = "";
    public bool IsHealthy { get; set; }
    public int MonitoredStreamsCount { get; set; }
    public DateTime LastUpdateTime { get; set; }
    public string? ErrorMessage { get; set; }
    public Dictionary<string, object> Metadata { get; set; } = new();
}

public class StreamStatusChangedEventArgs : EventArgs
{
    public StreamData Stream { get; set; }
    public bool IsOnline { get; set; }
    public DateTime Timestamp { get; set; } = DateTime.UtcNow;
}
```

### 依賴注入架構
**[Source: docs/brownfield-architecture.md#服務註冊和狀態追蹤機制]**

所有服務都透過 ASP.NET Core 的依賴注入容器管理，確保：
- 單例服務：Redis 連接、資料庫上下文、配置
- 瞬態服務：平台監控器、HTTP 客戶端
- 背景服務：CrawlerService 作為 Hosted Service 運行
- 健康檢查：整合 ASP.NET Core Health Checks

### 資料庫整合
**[Source: docs/brownfield-architecture.md#資料庫架構保持不變]**

繼續使用現有的 MySQL 資料庫和 Entity Framework 配置：
- 重用現有的 `MainDbContext` 和所有 Table 模型
- 無需修改資料庫 Schema 或 Migration 腳本
- 各服務獨立管理資料庫連接池
- 保持與 Discord Bot 的資料庫架構一致性

### Testing

**單元測試要求**:
- 測試配置載入和驗證邏輯
- 測試服務依賴注入設定
- 測試健康檢查端點
- 測試 CrawlerService 啟動和停止流程

**整合測試要求**:
- 測試資料庫連接和 Entity Framework 配置
- 測試 Redis 連接和基礎通訊
- 測試完整的服務啟動流程
- 測試配置檔案載入和環境變數覆蓋

**手動測試驗證**:
1. 驗證專案可以正常建置和執行
2. 檢查健康檢查端點回應正確狀態
3. 驗證所有依賴套件正確安裝
4. 測試配置檔案載入和驗證機制

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-18 | 1.0 | Story 初始建立 | Scrum Master |

## Dev Agent Record

_此區段由開發代理在實作期間填寫_

### Agent Model Used

_待開發代理填寫_

### Debug Log References

_待開發代理填寫_

### Completion Notes List

_待開發代理填寫_

### File List

_待開發代理填寫_

## QA Results

_此區段由 QA 代理在完成故事實作的 QA 審查後填寫_
