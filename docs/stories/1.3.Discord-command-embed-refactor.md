# Story 1.3: Discord 指令系統 Embed 回應重構

## Status
Draft

## Story
**As a** Discord 使用者,
**I want** 所有 Bot 指令回應都使用統一的 Discord Embed 格式,
**so that** 我可以獲得更清晰、美觀且一致的使用體驗

## Acceptance Criteria

1. [ ] 修改 `Command/` 目錄下所有指令使用 Embed 回應
   - 更新所有 YouTube 相關指令
   - 更新所有 Twitch 相關指令
   - 更新所有 Twitter 相關指令
   - 更新所有 TwitCasting 相關指令
   - 更新管理員指令和幫助指令
2. [ ] 修改 `Interaction/` 目錄下所有斜線指令使用 Embed 回應
   - 所有斜線指令統一使用 Embed 格式
   - 保持指令功能和參數不變
3. [ ] 建立統一的 Embed 樣式和顏色配置
   - 成功操作：綠色 (#00ff00)
   - 錯誤訊息：紅色 (#ff0000)
   - 資訊顯示：藍色 (#0099ff)
   - 警告訊息：橘色 (#ff9900)
4. [ ] 實作錯誤處理 Embed 格式化
   - 統一錯誤訊息 Embed 樣式
   - 包含錯誤代碼和解決建議
   - 友善的使用者錯誤說明
5. [ ] 確保所有平台追蹤指令保持現有介面不變
   - 指令名稱和參數保持一致
   - 功能邏輯完全相同
   - 只改變回應格式為 Embed

## Tasks / Subtasks

- [ ] Task 1: 建立統一 Embed 樣式系統 (AC: 3, 4)
  - [ ] 建立 `Utility/EmbedStyles.cs` 統一樣式管理
  - [ ] 定義顏色常數：
    - Success: #00ff00 (綠色)
    - Error: #ff0000 (紅色) 
    - Info: #0099ff (藍色)
    - Warning: #ff9900 (橘色)
  - [ ] 實作 Embed 建構方法：
    - `CreateSuccess(string title, string description)`
    - `CreateError(string title, string description)`
    - `CreateInfo(string title, string description)`
    - `CreateWarning(string title, string description)`
  - [ ] 實作錯誤處理 Embed 格式化方法

- [ ] Task 2: 重構 YouTube 相關指令 (AC: 1, 5)
  - [ ] 更新 `Command/Youtube/` 所有指令類別：
    - Follow/Unfollow 指令使用成功/錯誤 Embed
    - List 指令使用資訊 Embed 顯示追蹤清單
    - Status 查詢指令使用資訊 Embed
  - [ ] 更新 `Interaction/Youtube/` 所有斜線指令：
    - 保持相同指令參數和選項
    - 改用 Embed 回應格式
    - 確保 AutoComplete 功能正常運作
  - [ ] 保持現有指令功能完全不變

- [ ] Task 3: 重構其他平台指令 (AC: 1, 2, 5)
  - [ ] 更新 Twitch 相關指令 (`Command/Twitch/`, `Interaction/Twitch/`)：
    - 追蹤管理指令 Embed 化
    - 直播狀態查詢 Embed 格式
    - 保持現有功能邏輯
  - [ ] 更新 Twitter 相關指令 (`Command/Twitter/`, `Interaction/Twitter/`)：
    - Twitter Spaces 追蹤指令
    - 狀態查詢和清單顯示
  - [ ] 更新 TwitCasting 相關指令 (`Command/TwitCasting/`, `Interaction/Twitcasting/`)：
    - 直播追蹤和狀態查詢
    - 使用者管理相關指令

- [ ] Task 4: 重構管理員和系統指令 (AC: 1, 2)
  - [ ] 更新 `Command/Admin/` 管理員指令：
    - 系統狀態查詢使用資訊 Embed
    - 配置修改指令使用成功/錯誤 Embed
    - 日誌和診斷資訊 Embed 格式化
  - [ ] 更新 `Interaction/OwnerOnly/` 擁有者專用指令
  - [ ] 更新 `Command/Help/` 和 `Interaction/Help/` 幫助系統：
    - 指令清單使用資訊 Embed
    - 分頁顯示支援
    - 保持現有幫助內容

- [ ] Task 5: 實作通知訊息 Embed 格式 (AC: 3)
  - [ ] 更新直播通知 Embed 格式：
    - 開台通知使用成功色系 Embed
    - 關台通知使用資訊色系 Embed
    - 會員限定直播使用特殊標示
  - [ ] 統一通知 Embed 結構：
    - 標題：直播標題或狀態
    - 描述：頻道連結和基本資訊
    - 縮圖：直播封面圖片
    - 欄位：排程時間、狀態等資訊
    - 腳註：平台和時間戳記

- [ ] Task 6: 錯誤處理和異常情況 Embed (AC: 4)
  - [ ] 建立標準錯誤 Embed 格式：
    - 清晰的錯誤標題
    - 詳細錯誤描述
    - 可能的解決方案建議
    - 聯繫管理員的方式（如適用）
  - [ ] 常見錯誤情況 Embed 模板：
    - API 限制錯誤
    - 權限不足錯誤
    - 網路連接錯誤
    - 資料庫存取錯誤
  - [ ] 實作使用者友善的錯誤說明

- [ ] Task 7: 整合現有系統和測試 (AC: 1-5)
  - [ ] 確保與 `EmojiService` 的整合：
    - Embed 中使用適當的 Emoji
    - 保持現有 Emoji 使用邏輯
  - [ ] 驗證與資料庫服務的整合：
    - 確保 Embed 不影響資料存取
    - 保持現有業務邏輯完整性
  - [ ] 測試所有指令的 Embed 回應：
    - 功能測試確保指令正常運作
    - UI 測試確保 Embed 顯示正確
    - 邊界條件測試（長文本、特殊字符等）

## Dev Notes

### Discord Embed 系統概述
**[Source: docs/brownfield-prd.md#FR2-Discord-Embed-格式統一]**

此 Story 的目標是將所有使用者指令回應統一為 Discord Embed 格式，提升使用者體驗並保持介面一致性。這是 Discord Bot 重構的重要組成部分，為未來的事件驅動架構做準備。

### Discord.Net Embed API 參考

**基礎 EmbedBuilder 使用**:
```csharp
var embed = new EmbedBuilder()
    .WithTitle("標題")
    .WithDescription("描述內容")
    .WithColor(Color.Green)
    .WithTimestamp(DateTimeOffset.Now)
    .WithFooter("腳註文字", iconUrl: "圖示URL")
    .AddField("欄位名稱", "欄位內容", inline: true)
    .WithThumbnailUrl("縮圖URL")
    .WithImageUrl("圖片URL")
    .WithUrl("連結URL")
    .Build();

await ReplyAsync(embed: embed);
```

### 統一樣式系統設計

**EmbedStyles 類別架構**:
```csharp
public static class EmbedStyles
{
    // 顏色定義
    public static readonly Color Success = new Color(0, 255, 0);      // #00ff00
    public static readonly Color Error = new Color(255, 0, 0);        // #ff0000  
    public static readonly Color Info = new Color(0, 153, 255);       // #0099ff
    public static readonly Color Warning = new Color(255, 153, 0);    // #ff9900
    
    // 基礎建構方法
    public static EmbedBuilder CreateSuccess(string title, string description = null)
    {
        return new EmbedBuilder()
            .WithColor(Success)
            .WithTitle($"✅ {title}")
            .WithDescription(description)
            .WithTimestamp(DateTimeOffset.Now);
    }
    
    public static EmbedBuilder CreateError(string title, string description = null, string suggestion = null)
    {
        var builder = new EmbedBuilder()
            .WithColor(Error)
            .WithTitle($"❌ {title}")
            .WithDescription(description)
            .WithTimestamp(DateTimeOffset.Now);
            
        if (!string.IsNullOrEmpty(suggestion))
            builder.AddField("💡 建議", suggestion);
            
        return builder;
    }
    
    public static EmbedBuilder CreateInfo(string title, string description = null)
    {
        return new EmbedBuilder()
            .WithColor(Info)
            .WithTitle($"ℹ️ {title}")
            .WithDescription(description)
            .WithTimestamp(DateTimeOffset.Now);
    }
    
    public static EmbedBuilder CreateWarning(string title, string description = null)
    {
        return new EmbedBuilder()
            .WithColor(Warning)
            .WithTitle($"⚠️ {title}")
            .WithDescription(description)
            .WithTimestamp(DateTimeOffset.Now);
    }
}
```

### 現有指令架構分析
**[Source: 專案結構 Command/ 和 Interaction/ 目錄]**

**傳統指令結構** (`Command/`):
- 各平台獨立目錄：`Youtube/`, `Twitch/`, `Twitter/`, `TwitCasting/`
- 管理功能：`Admin/`, `Help/`, `Normal/`
- 基於 `CommandHandler.cs` 的指令處理

**斜線指令結構** (`Interaction/`):
- 相同的平台目錄結構
- 基於 `InteractionHandler.cs` 的互動處理
- 支援 AutoComplete 和複雜參數

### 指令重構範例

**YouTube Follow 指令重構前**:
```csharp
[SlashCommand("follow", "追蹤 YouTube 頻道")]
public async Task FollowYouTubeChannel(string channelUrl)
{
    try
    {
        var result = await _youtubeService.AddFollowAsync(channelUrl, Context.Guild.Id);
        await RespondAsync($"已成功追蹤 {result.ChannelTitle}");
    }
    catch (Exception ex)
    {
        await RespondAsync($"追蹤失敗: {ex.Message}");
    }
}
```

**重構後**:
```csharp
[SlashCommand("follow", "追蹤 YouTube 頻道")]
public async Task FollowYouTubeChannel(string channelUrl)
{
    try
    {
        var result = await _youtubeService.AddFollowAsync(channelUrl, Context.Guild.Id);
        
        var embed = EmbedStyles.CreateSuccess("追蹤成功", $"已成功追蹤頻道")
            .WithDescription($"[{result.ChannelTitle}]({channelUrl})")
            .WithThumbnailUrl(result.ChannelThumbnailUrl)
            .AddField("頻道 ID", result.ChannelId, true)
            .AddField("追蹤時間", DateTime.Now.ToString("yyyy-MM-dd HH:mm"), true)
            .Build();
            
        await RespondAsync(embed: embed);
    }
    catch (Exception ex)
    {
        var errorEmbed = EmbedStyles.CreateError("追蹤失敗", ex.Message, 
            "請檢查 URL 格式是否正確，或聯繫管理員")
            .Build();
            
        await RespondAsync(embed: errorEmbed);
    }
}
```

### 通知訊息 Embed 格式規範

**直播開台通知 Embed**:
```csharp
public static EmbedBuilder CreateStreamStartNotification(StreamData stream)
{
    return EmbedStyles.CreateSuccess("🔴 直播開始")
        .WithDescription($"[{stream.ChannelTitle}]({stream.ChannelUrl})")
        .WithTitle(stream.VideoTitle)
        .WithUrl($"https://www.youtube.com/watch?v={stream.VideoId}")
        .WithImageUrl($"https://i.ytimg.com/vi/{stream.VideoId}/maxresdefault.jpg")
        .AddField("開台時間", stream.ActualStartTime?.ToString("MM/dd HH:mm") ?? "現在", true)
        .AddField("平台", "YouTube", true)
        .AddField("類型", stream.IsMememberOnly ? "會員限定" : "公開直播", true);
}
```

**錯誤處理 Embed 規範**:
```csharp
public static class CommonErrors
{
    public static EmbedBuilder CreateApiLimitError(string platform)
    {
        return EmbedStyles.CreateError($"{platform} API 配額已達上限", 
            "目前 API 調用次數已達每日上限，請稍後再試",
            "此限制通常會在每日 00:00 (UTC) 重置");
    }
    
    public static EmbedBuilder CreatePermissionError()
    {
        return EmbedStyles.CreateError("權限不足", 
            "您沒有足夠的權限執行此操作",
            "請聯繫伺服器管理員獲取相應權限");
    }
}
```

### 與現有系統整合

**EmojiService 整合**:
- 保持現有 Emoji 使用邏輯
- 在 Embed 標題或描述中使用適當的 Emoji
- 利用 `EmojiService` 獲取平台特定的 Emoji

**資料庫服務整合**:
- Embed 重構不影響現有業務邏輯
- 保持與 `MainDbService` 的正常互動
- 確保 Entity Framework 操作無變化

**Redis PubSub 準備**:
- 設計 Embed 格式時考慮未來事件驅動需求
- 統一的通知格式便於 Event Handler 使用（Story 1.2）

### 效能和使用考量

**Discord Embed 大小限制** _(參考: [Discord Developer Docs - Embed Limits](https://discord.com/developers/docs/resources/message#embed-limits))_:
- **總字符數限制**：6000 字符（所有文字欄位加總）
- **標題 (title)**：256 字符
- **描述 (description)**：4096 字符
- **欄位數量 (fields)**：最多 25 個
- **欄位名稱 (field.name)**：256 字符
- **欄位值 (field.value)**：1024 字符
- **腳註文字 (footer.text)**：2048 字符
- **作者名稱 (author.name)**：256 字符

**最佳實務**:
- 避免過長的描述或欄位內容
- 使用適當的縮略和省略
- 合理使用 inline 欄位進行排版
- 保持視覺一致性和可讀性

### Testing

**功能測試重點**:
- 所有指令回應格式正確
- 成功/錯誤情況下 Embed 顯示適當
- 長文本內容的處理
- 特殊字符和 Unicode 支援

**視覺測試檢查**:
- 顏色配置在 Discord 中的顯示效果
- 排版和佈局的美觀性
- 不同裝置（桌面/移動）的顯示相容性

**回歸測試**:
- 確保所有現有指令功能正常
- AutoComplete 功能未受影響
- 權限檢查和業務邏輯完整性

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-18 | 1.0 | Story 初始建立 | Scrum Master |

## Dev Agent Record

_此區段由開發代理在實作期間填寫_

### Agent Model Used

_待開發代理填寫_

### Debug Log References

_待開發代理填寫_

### Completion Notes List

_待開發代理填寫_

### File List

_待開發代理填寫_

## QA Results

_此區段由 QA 代理在完成故事實作的 QA 審查後填寫_
